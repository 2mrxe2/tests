name: WireGuard-VPN
on:
  workflow_dispatch:

jobs:
  wg:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      - name: == START ==
        run: echo "ðŸš€ Starting WireGuard VPN setup..."

      - name: Update system
        run: |
          set -x
          sudo apt update
          sudo apt install -y wireguard qrencode iproute2 resolvconf

      - name: Detect interface
        run: |
          set -x
          IFACE=$(ip route get 1.1.1.1 | awk '{print $5; exit}')
          echo "Detected interface: $IFACE"
          echo "IFACE=$IFACE" >> $GITHUB_ENV

      - name: Enable forwarding
        run: |
          set -x
          echo "net.ipv4.ip_forward=1" | sudo tee /etc/sysctl.d/99-wg.conf
          sudo sysctl -p /etc/sysctl.d/99-wg.conf

      - name: Generate keys
        run: |
          set -x
          SERVER_PRIV=$(wg genkey)
          SERVER_PUB=$(echo "$SERVER_PRIV" | wg pubkey)
          CLIENT_PRIV=$(wg genkey)
          CLIENT_PUB=$(echo "$CLIENT_PRIV" | wg pubkey)
          echo "$SERVER_PRIV" > server_priv
          echo "$SERVER_PUB" > server_pub
          echo "$CLIENT_PRIV" > client_priv
          echo "$CLIENT_PUB" > client_pub

      - name: Detect public IP
        run: |
          set -x
          PUBLIC_IP=$(curl -s https://api.ipify.org)
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "Detected IP: $PUBLIC_IP"

      - name: Setup WireGuard
        run: |
          set -x
          SERVER_PRIV=$(cat server_priv)
          CLIENT_PUB=$(cat client_pub)
          sudo mkdir -p /etc/wireguard
          cat <<EOF | sudo tee /etc/wireguard/wg0.conf
[Interface]
PrivateKey = $SERVER_PRIV
Address = 10.77.0.1/24
ListenPort = 51820
PostUp   = iptables -t nat -A POSTROUTING -o ${IFACE} -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o ${IFACE} -j MASQUERADE

[Peer]
PublicKey = $CLIENT_PUB
AllowedIPs = 10.77.0.2/32
EOF

      - name: Start WireGuard
        run: |
          set -x
          sudo wg-quick up wg0
          sudo wg

      - name: Build client config
        run: |
          set -x
          SERVER_PUB=$(cat server_pub)
          CLIENT_PRIV=$(cat client_priv)
          cat <<EOF > client.conf
[Interface]
PrivateKey = $CLIENT_PRIV
Address = 10.77.0.2/32
DNS = 1.1.1.1

[Peer]
PublicKey = $SERVER_PUB
Endpoint = ${PUBLIC_IP}:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
EOF

      - name: Show QR
        run: |
          set -x
          echo "Scan this QR:"
          qrencode -t ANSIUTF8 < client.conf
          echo "Client config:"
          cat client.conf

      - name: Keep-alive
        run: |
          set -x
          while true; do
            echo "[$(date)] WireGuard running..."
            sleep 60
          done
