name: WireGuard VPN Proof of Concept Test

# ูุณูุญ ุจุชุดุบูู ุงูู Workflow ูุฏููุงู ูู ูุงุฌูุฉ GitHub
on:
  workflow_dispatch:

jobs:
  run-vpn-server:
    # ุณูุชู ุงูุชุดุบูู ุนูู ุฃุญุฏุซ ุจูุฆุฉ Ubuntu Runner
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ ุจุฏุก ูููุฉ ุฎุงุฏู VPN
        run: echo "Starting WireGuard VPN Server on GitHub Runner..."
      
      - name: ๐ฆ ุชุซุจูุช WireGuard ูุงูุฃุฏูุงุช ุงููุงุฒูุฉ
        # ุชุญุฏูุซ ุงูุญุฒู ูุชุซุจูุช WireGuard ู net-tools (ููุชุดุฎูุต)
        run: sudo apt-get update && sudo apt-get install -y wireguard net-tools
        
      - name: ๐ ุฅุนุฏุงุฏ ูุงุฌูุฉ WireGuard ูุชูุนูู ุงูุชูุฌูู (NAT/Routing)
        env:
          # ูููุฑุฑ ุงูููุชุงุญ ุงูุฎุงุต ููุฎุงุฏู ูู GitHub Secrets
          SERVER_PRIVATE_KEY: ${{ secrets.VPN_SERVER_PRIVATE_KEY }}
          # ุงูููุชุงุญ ุงูุนุงู ููุงุชูู ุงูุฐู ุฃุฑุณูุชู
          CLIENT_PUBLIC_KEY:  '9Tqw+1M8fqzmeKGqGPqct45SsOv/kDPgdFIfrFWlSjA=' 
          SERVER_IP: 10.0.0.1
          CLIENT_IP: 10.0.0.2
        run: |
          # 0. ุงูุชุญูู ูู ูุฌูุฏ ุงูููุชุงุญ ุงูุฎุงุต ููุฎุงุฏู
          if [ -z "${SERVER_PRIVATE_KEY}" ]; then
            echo "::error::SERVER_PRIVATE_KEY Secret is empty or missing. Check GitHub Secrets."
            exit 1
          fi

          # 1. ุฅูุดุงุก ููู ุชููุฆุฉ wg0.conf ุจุงุณุชุฎุฏุงู 'EOF' ูุถูุงู ุงูุชูุณูู ุงูุณููู
          sudo tee /etc/wireguard/wg0.conf << EOF
          [Interface]
          Address = ${SERVER_IP}/24
          ListenPort = 51820
          PrivateKey = ${SERVER_PRIVATE_KEY}
          
          [Peer]
          PublicKey = ${CLIENT_PUBLIC_KEY}
          AllowedIPs = ${CLIENT_IP}/32
          PersistentKeepalive = 25
          EOF
          
          # 2. ุชูููู IP Forwarding (ุถุฑูุฑู ูุชูุฌูู ุงูุฅูุชุฑูุช)
          echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

          # 3. ุฅุนุฏุงุฏ NAT (ู ูุดุงุฑูุฉ ุฅูุชุฑูุช ุงูู Runner ูุน ุงูุนููู)
          sudo iptables -A FORWARD -i wg0 -j ACCEPT
          sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          
          # 4. ุชุดุบูู ูุงุฌูุฉ WireGuard
          sudo wg-quick up wg0
          
          # 5. ุนุฑุถ ุญุงูุฉ ุงููุงุฌูุฉ ููุชุฃูุฏ
          wg show wg0

      - name: โณ ุชุดุบูู ุงูุฎุงุฏู ููุฏุฉ 5 ุณุงุนุงุช ู 55 ุฏูููุฉ (ุงูุญุฏ ุงูุฃูุตู ููุชุฌุฑุจุฉ)
        run: |
          echo "WireGuard Server is now running."
          echo "================================================="
          echo "๐ฅ ูุงู: ูุฐุง ูู ุนููุงู IP ุงูุนุงู ููู Runner. ุงุณุชุฎุฏูู ูููุทุฉ ุงุชุตุงู (Endpoint):"
          # ุงุณุชุฎุฏุงู curl ููุนุฑูุฉ ุงูู IP ุงูุนุงู ููู Runner
          curl ifconfig.me
          echo ""
          echo "================================================="
          echo "ุงูุฎุงุฏู ุณูุนูู ููุฏุฉ 5 ุณุงุนุงุช ู 55 ุฏูููุฉ ูุญุฏ ุฃูุตู. ูู ุจุงูุงุชุตุงู ุจูุงุชูู ุงูุขู."
          # ุงูุงูุชุธุงุฑ ููุฏุฉ ุทูููุฉ ููุญูุงุธ ุนูู ุงูู Job ููุฏ ุงูุชุดุบูู
          sleep 5h55m
          echo "ุงูุชูู ููุช ุงูุชุฌุฑุจุฉ. ุฅููุงู VPN."
          
      - name: ๐ซ ุฅููุงู ูุชูุธูู ุงููุงุฌูุฉ
        if: always()
        run: |
          # ุงุณุชุฎุฏุงู '|| true' ูุถูุงู ุนุฏู ูุดู ุงูุฎุทูุฉ ุญุชู ูู ูู ุชูู ุงููุงุฌูุฉ ููุฌูุฏุฉ
          sudo wg-quick down wg0 || true
          echo "Cleanup complete."
