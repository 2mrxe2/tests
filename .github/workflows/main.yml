name: WireGuard VPN Proof of Concept

on:
  # Ø§Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
  workflow_dispatch:

jobs:
  run-vpn-server:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Start VPN Server Job
        run: echo "Starting WireGuard VPN Server on GitHub Runner..."
      
      - name: ğŸ“¦ Install WireGuard
        run: sudo apt-get update && sudo apt-get install -y wireguard net-tools
        
      - name: ğŸ”‘ Configure WireGuard Interface
        env:
          SERVER_PRIVATE_KEY: ${{ secrets.VPN_SERVER_PRIVATE_KEY }}
          CLIENT_PUBLIC_KEY:  '**<Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ù„Ù‡Ø§ØªÙÙƒ Ù‡Ù†Ø§>**' # Ø§Ø³ØªØ¨Ø¯Ù„
          SERVER_IP: 10.0.0.1
          CLIENT_IP: 10.0.0.2
        run: |
          # 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ØªÙ‡ÙŠØ¦Ø© wg0.conf
          echo "[Interface]" | sudo tee /etc/wireguard/wg0.conf
          echo "Address = $SERVER_IP/24" | sudo tee -a /etc/wireguard/wg0.conf
          echo "ListenPort = 51820" | sudo tee -a /etc/wireguard/wg0.conf
          echo "PrivateKey = $SERVER_PRIVATE_KEY" | sudo tee -a /etc/wireguard/wg0.conf
          
          # 2. Ø¥Ø¶Ø§ÙØ© Peer (Ø§Ù„Ù‡Ø§ØªÙ)
          echo "" | sudo tee -a /etc/wireguard/wg0.conf
          echo "[Peer]" | sudo tee -a /etc/wireguard/wg0.conf
          echo "PublicKey = $CLIENT_PUBLIC_KEY" | sudo tee -a /etc/wireguard/wg0.conf
          echo "AllowedIPs = $CLIENT_IP/32" | sudo tee -a /etc/wireguard/wg0.conf
          
          # 3. ØªÙ…ÙƒÙŠÙ† IP Forwarding (Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)
          echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p
          
          # 4. Ø¥Ø¹Ø¯Ø§Ø¯ NAT (Ø§Ù„Ù€ Runner Ù‡Ùˆ Ø§Ù„Ù…Ù†ÙØ°ØŒ Ø¹Ø§Ø¯Ø©Ù‹ eth0)
          # Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªÙŠ "ØªØ´Ø§Ø±Ùƒ" Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
          sudo iptables -A FORWARD -i wg0 -j ACCEPT
          sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          
          # 5. ØªØ´ØºÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© WireGuard
          sudo wg-quick up wg0

      - name: â³ Keep Runner Alive (6 Hours Max)
        # Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø³ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù€ Job Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù…Ø¯Ø© 5 Ø³Ø§Ø¹Ø§Øª Ùˆ 55 Ø¯Ù‚ÙŠÙ‚Ø©
        # Ù…Ù…Ø§ ÙŠØªÙŠØ­ Ù„Ùƒ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙƒØ§ÙÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
        run: |
          echo "VPN Server is running. Public IP of this runner is:"
          curl ifconfig.me
          echo ""
          echo "The VPN will run for a maximum of 5 hours and 55 minutes."
          echo "Connect your phone now using the client config below."
          sleep 5h55m
          echo "Time limit reached. Stopping VPN."
          
      - name: ğŸš« Clean up
        if: always()
        run: |
          sudo wg-quick down wg0
          echo "Cleanup complete."
