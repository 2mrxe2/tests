name: WireGuard VPN (GitHub Runner)

on:
  workflow_dispatch:

jobs:
  run-wg:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # أقصى وقت تشغيل 6 ساعات

    steps:
      - name: Update system
        run: |
          sudo apt update
          sudo apt install -y wireguard qrencode iproute2

      - name: Enable IP forwarding
        run: |
          echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      - name: Generate WireGuard keys
        run: |
          SERVER_PRIV=$(wg genkey)
          SERVER_PUB=$(echo "$SERVER_PRIV" | wg pubkey)
          CLIENT_PRIV=$(wg genkey)
          CLIENT_PUB=$(echo "$CLIENT_PRIV" | wg pubkey)

          echo "$SERVER_PRIV" > server_priv
          echo "$SERVER_PUB" > server_pub
          echo "$CLIENT_PRIV" > client_priv
          echo "$CLIENT_PUB" > client_pub

      - name: Prepare WireGuard server config
        run: |
          SERVER_PRIV=$(cat server_priv)
          CLIENT_PUB=$(cat client_pub)

          # Get GitHub Runner public IP
          PUBLIC_IP=$(curl -s https://api.ipify.org)

          cat <<EOF | sudo tee /etc/wireguard/wg0.conf
[Interface]
Address = 10.50.50.1/24
ListenPort = 51820
PrivateKey = $SERVER_PRIV
SaveConfig = false

PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = $CLIENT_PUB
AllowedIPs = 10.50.50.2/32
EOF

      - name: Start WireGuard
        run: sudo wg-quick up wg0

      - name: Generate client config
        run: |
          SERVER_PUB=$(cat server_pub)
          CLIENT_PRIV=$(cat client_priv)
          PUBLIC_IP=$(curl -s https://api.ipify.org)

          cat <<EOF > client.conf
[Interface]
PrivateKey = $CLIENT_PRIV
Address = 10.50.50.2/32
DNS = 1.1.1.1

[Peer]
PublicKey = $SERVER_PUB
Endpoint = $PUBLIC_IP:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
EOF

      - name: Show QR Code
        run: |
          echo "Scan this QR with WireGuard app:"
          qrencode -t ANSIUTF8 < client.conf
          echo ""
          echo "----- Client Config (copy if needed) -----"
          cat client.conf

      - name: Keep runner alive
        run: |
          echo "WireGuard is running..."
          echo "Press Cancel Workflow to stop."
          sleep 3600  # ساعة كاملة
