name: WireGuard VPN (GitHub Runner)

on:
  workflow_dispatch:

jobs:
  wg:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install packages
        run: |
          sudo apt update
          sudo apt install -y wireguard qrencode iproute2 resolvconf

      - name: Detect network interface
        run: |
          IFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')
          echo "IFACE=$IFACE" >> $GITHUB_ENV

      - name: Enable IP forwarding
        run: |
          echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      - name: Generate keys
        run: |
          SERVER_PRIV=$(wg genkey)
          SERVER_PUB=$(echo "$SERVER_PRIV" | wg pubkey)
          CLIENT_PRIV=$(wg genkey)
          CLIENT_PUB=$(echo "$CLIENT_PRIV" | wg pubkey)

          echo "$SERVER_PRIV" > server_priv
          echo "$SERVER_PUB" > server_pub
          echo "$CLIENT_PRIV" > client_priv
          echo "$CLIENT_PUB" > client_pub

      - name: Get public IP
        run: |
          echo "PUBLIC_IP=$(curl -s https://api.ipify.org)" >> $GITHUB_ENV

      - name: Configure WireGuard
        run: |
          SERVER_PRIV=$(cat server_priv)
          CLIENT_PUB=$(cat client_pub)

          sudo mkdir -p /etc/wireguard
          cat <<EOF | sudo tee /etc/wireguard/wg0.conf
[Interface]
PrivateKey = $SERVER_PRIV
Address = 10.77.0.1/24
ListenPort = 51820

PostUp = iptables -t nat -A POSTROUTING -o ${IFACE} -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o ${IFACE} -j MASQUERADE

[Peer]
PublicKey = $CLIENT_PUB
AllowedIPs = 10.77.0.2/32
EOF

      - name: Start WG
        run: sudo wg-quick up wg0

      - name: Create client config
        run: |
          SERVER_PUB=$(cat server_pub)
          CLIENT_PRIV=$(cat client_priv)

          cat <<EOF > client.conf
[Interface]
PrivateKey = $CLIENT_PRIV
Address = 10.77.0.2/32
DNS = 1.1.1.1

[Peer]
PublicKey = $SERVER_PUB
Endpoint = ${PUBLIC_IP}:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
EOF

      - name: Show QR
        run: |
          echo "===== Scan QR with WireGuard ====="
          qrencode -t ANSIUTF8 < client.conf
          echo ""
          echo "===== Client Config ====="
          cat client.conf

      - name: Keep alive
        run: |
          echo "WireGuard running for 60 minutes..."
          sleep 3600
